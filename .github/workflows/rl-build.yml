name: RL Interface Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Projects/CMakeLists.txt'
      - 'python/**'
      - 'external/**'
      - '.github/workflows/rl-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Projects/CMakeLists.txt'
      - 'python/**'
      - 'external/**'
      - '.github/workflows/rl-build.yml'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        architecture: ['x64']

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libgtk2.0-dev \
          libsdl2-dev \
          libsdl2-net-dev \
          libopenal-dev \
          libpython${{ matrix.python-version }}-dev \
          python${{ matrix.python-version }}-numpy

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11[global]>=2.10.0 setuptools>=65.0 wheel gymnasium numpy

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. \
          -DOG_RL=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DPYTHON_EXECUTABLE=$(which python) \
          -G Ninja

    - name: Build
      run: |
        cd build
        ninja og_rl_interface

    - name: Test Python package
      run: |
        cd python
        python -c "import sys; sys.path.insert(0, '../build'); import og_rl_interface"

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        architecture: ['x64']

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11[global]>=2.10.0 setuptools>=65.0 wheel gymnasium numpy

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. `
          -DOG_RL=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DPYTHON_EXECUTABLE=$(python -c "import sys; print(sys.executable)") `
          -G "Visual Studio 17 2022"

    - name: Build
      run: |
        cd build
        cmake --build . --config Release --target og_rl_interface

    - name: Test Python package
      run: |
        cd python
        python -c "import sys; sys.path.insert(0, '../build/Release'); import og_rl_interface"

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        brew install cmake ninja sdl2 openal-soft

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11[global]>=2.10.0 setuptools>=65.0 wheel gymnasium numpy

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. \
          -DOG_RL=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DPYTHON_EXECUTABLE=$(which python) \
          -G Ninja

    - name: Build
      run: |
        cd build
        ninja og_rl_interface

    - name: Test Python package
      run: |
        cd python
        python -c "import sys; sys.path.insert(0, '../build'); import og_rl_interface"

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort

    - name: Lint Python code
      run: |
        cd python
        black --check --diff .
        flake8 --max-line-length=88 --extend-ignore=E203,W503 .
        isort --check-only --diff .